<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build Your Portfolio</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .form-container { max-width: 800px; margin: 2rem auto; padding: 2rem; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .form-section { margin-bottom: 2.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #dee2e6; }
        .form-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0;}
        .dynamic-entry { position: relative; padding: 1.5rem; border: 1px solid #e9ecef; border-radius: .5rem; margin-bottom: 1rem; background-color: #f8f9fa; }
        .btn-remove { position: absolute; top: 0.5rem; right: 0.5rem; }
        .suggestion-item { cursor: pointer; }
        .suggestion-item:hover { background-color: #e9ecef; }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-container">
            <h2 class="text-center fw-bold mb-4">Build Your Professional Resume</h2>
            <form id="portfolio-form" action="{{ url_for('save_portfolio') }}" method="POST">
                
                {% if data.id %}
                <input type="hidden" name="user_id" value="{{ data.id }}">
                {% endif %}

                <div class="form-section">
                    <h3><i class="fas fa-user-circle me-2"></i>Personal Details</h3>
                    <div class="row g-3">
                        <div class="col-md-6"><input type="text" class="form-control" name="name" placeholder="Full Name" value="{{ data.name or '' }}" required></div>
                        <div class="col-md-6"><input type="text" class="form-control" name="title" placeholder="Professional Title (e.g., Software Engineer)" value="{{ data.title or '' }}" required></div>
                        <div class="col-md-6"><input type="email" class="form-control" name="email" placeholder="Email Address" value="{{ data.email or '' }}" required></div>
                        <div class="col-md-6"><input type="tel" class="form-control" name="phone" placeholder="Phone Number" value="{{ data.phone or '' }}" required></div>
                        <div class="col-md-12"><input type="text" class="form-control" name="location" placeholder="City, Country" value="{{ data.location or '' }}" required></div>
                        <div class="col-md-12"><input type="url" class="form-control" name="profile_picture" placeholder="Profile Picture URL (for Web Portfolio)" value="{{ data.profile_picture or '' }}"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-share-alt me-2"></i>Social & Professional Links</h3>
                    <div class="row g-3">
                        <div class="col-md-6"><input type="url" class="form-control" name="linkedin_url" placeholder="LinkedIn Profile URL" value="{{ data.linkedin_url or '' }}"></div>
                        <div class="col-md-6"><input type="url" class="form-control" name="github_url" placeholder="GitHub Profile URL" value="{{ data.github_url or '' }}"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-info-circle me-2"></i>Professional Summary</h3>
                    <textarea class="form-control" id="about_me" name="about_me" rows="4" placeholder="Write a brief summary of your career, skills, and goals..." required>{{ data.about_me or '' }}</textarea>
                    <button type="button" class="btn btn-primary mt-2" onclick="generateSummaryOptions()"><i class="fas fa-magic me-2"></i>Suggest Summaries with AI</button>
                    <div id="summary-suggestions" class="list-group mt-3"></div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-star me-2"></i>Skills</h3>
                    <div id="skills-container"></div>
                    <button type="button" class="btn btn-secondary mt-2" onclick="addSkillCategory()">Add Skill Category</button>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-briefcase me-2"></i>Work Experience</h3>
                    <div id="experience-container"></div>
                    <button type="button" class="btn btn-secondary mt-2" onclick="addEntry('experience')">Add Experience</button>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-code me-2"></i>Projects</h3>
                    <div id="project-container"></div>
                    <button type="button" class="btn btn-secondary mt-2" onclick="addEntry('project')">Add Project</button>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-graduation-cap me-2"></i>Education</h3>
                    <div id="education-container"></div>
                    <button type="button" class="btn btn-secondary mt-2" onclick="addEntry('education')">Add Education</button>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-certificate me-2"></i>Certificates</h3>
                    <div id="certificate-container"></div>
                    <button type="button" class="btn btn-secondary mt-2" onclick="addEntry('certificate')">Add Certificate</button>
                </div>
                
                <button type="submit" class="btn btn-success w-100 btn-lg">{{ 'Update Portfolio' if data.id else 'Create Portfolio' }}</button>
            </form>
        </div>
    </div>

    <script id="portfolio-data" type="application/json">{{ data | tojson | safe }}</script>

    <script>
        const counters = { experience: 0, education: 0, project: 0, certificate: 0, skill: 0 };

        function getTemplate(type, id, data = {}) {
            const removeBtn = `<button type="button" class="btn btn-danger btn-sm btn-remove" onclick="this.closest('.dynamic-entry').remove()"><i class="fas fa-times"></i></button>`;
            
            if (type === 'experience') {
                return `<h5>Experience #${id}</h5>${removeBtn}
                        <div class="row g-3">
                            <div class="col-md-6"><input type="text" class="form-control" name="experience_role_${id}" placeholder="Role" value="${data.role || ''}" required></div>
                            <div class="col-md-6"><input type="text" class="form-control" name="experience_company_${id}" placeholder="Company" value="${data.company || ''}" required></div>
                            <div class="col-md-6"><input type="text" class="form-control" name="experience_location_${id}" placeholder="Location (e.g., San Francisco, CA)" value="${data.location || ''}"></div>
                            <div class="col-md-6"><input type="text" class="form-control" name="experience_date_range_${id}" placeholder="Date Range (e.g., Jan 2020 - Present)" value="${data.date_range || ''}" required></div>
                            <div class="col-12"><textarea class="form-control" id="experience_description_${id}" name="experience_description_${id}" rows="4" placeholder="Description (use bullet points)..." required>${data.description || ''}</textarea></div>
                            <div class="col-12"><div class="input-group"><input type="text" class="form-control" id="experience_keywords_${id}" placeholder="Keywords (e.g., 'managed team, deployed app')"><button class="btn btn-outline-primary" type="button" onclick="generateExperience(${id})">Generate Description</button></div></div>
                        </div>`;
            }
            if (type === 'education') {
                return `<h5>Education #${id}</h5>${removeBtn}
                        <div class="row g-3">
                            <div class="col-12"><input type="text" class="form-control" name="program_name_${id}" placeholder="Program/Degree" value="${data.program_name || ''}" required></div>
                            <div class="col-md-6"><input type="text" class="form-control" name="university_${id}" placeholder="University/School" value="${data.university || ''}" required></div>
                            <div class="col-md-6"><input type="text" class="form-control" name="education_location_${id}" placeholder="Location (e.g., Berkeley, CA)" value="${data.location || ''}"></div>
                            <div class="col-md-6"><input type="text" class="form-control" name="education_date_range_${id}" placeholder="Date Range (e.g., Aug 2013 - May 2017)" value="${data.date_range || ''}" required></div>
                            <div class="col-md-6 input-group"><input type="text" class="form-control" name="grade_${id}" placeholder="Grade" value="${data.grade || ''}" required><span class="input-group-text">Type:</span><select class="form-select" name="grade_type_${id}"><option value="CGPA" ${data.grade_type === 'CGPA' ? 'selected' : ''}>CGPA</option><option value="Percentage" ${data.grade_type === 'Percentage' ? 'selected' : ''}>Percentage</option><option value="GPA" ${data.grade_type === 'GPA' ? 'selected' : ''}>GPA</option></select></div>
                        </div>`;
            }
            if (type === 'project') {
                return `<h5>Project #${id}</h5>${removeBtn}
                        <div class="row g-3">
                            <div class="col-12"><input type="text" class="form-control" name="project_name_${id}" placeholder="Project Name" value="${data.project_name || ''}" required></div>
                            <div class="col-md-6"><input type="text" class="form-control" name="project_date_range_${id}" placeholder="Date Range (e.g., Jan 2020 - Mar 2020)" value="${data.date_range || ''}"></div>
                            <div class="col-md-6"><input type="url" class="form-control" name="project_link_${id}" placeholder="Project Link" value="${data.link || ''}"></div>
                            <div class="col-12"><input type="text" class="form-control" name="skills_${id}" placeholder="Technologies Used (comma-separated)" value="${data.skills || ''}" required></div>
                            <div class="col-12"><textarea class="form-control" id="project_description_${id}" name="description_${id}" rows="3" placeholder="Description..." required>${data.description || ''}</textarea></div>
                            <div class="col-12"><div class="input-group"><input type="text" class="form-control" id="project_brief_${id}" placeholder="Short brief of the project"><button class="btn btn-outline-primary" type="button" onclick="generateProject(${id})">Generate Description</button></div></div>
                        </div>`;
            }
            if (type === 'certificate') {
                 return `<h5>Certificate #${id}</h5>${removeBtn}
                        <div class="row g-3">
                           <div class="col-md-6"><input type="text" class="form-control" name="certificate_name_${id}" placeholder="Certificate Name" value="${data.name || ''}" required></div>
                           <div class="col-md-6"><input type="text" class="form-control" name="certificate_issuer_${id}" placeholder="Issuing Organization" value="${data.issuer || ''}" required></div>
                           <div class="col-md-6"><input type="text" class="form-control" name="certificate_date_${id}" placeholder="Date (e.g., March 2023)" value="${data.date || ''}"></div>
                           <div class="col-md-6"><input type="url" class="form-control" name="certificate_link_${id}" placeholder="Credential Link" value="${data.link || ''}"></div>
                        </div>`;
            }
        }

        function addEntry(type, data = {}) {
            counters[type]++;
            const container = document.getElementById(`${type}-container`);
            const newEntry = document.createElement('div');
            newEntry.className = 'dynamic-entry';
            newEntry.innerHTML = getTemplate(type, counters[type], data);
            container.appendChild(newEntry);
        }

        function addSkillCategory(category = '', names = '') {
             counters.skill++;
             const container = document.getElementById('skills-container');
             const newEntry = document.createElement('div');
             newEntry.className = 'dynamic-entry';
             newEntry.innerHTML = `<div class="row g-3 align-items-center">
                                      <div class="col-md-4"><input type="text" class="form-control" name="skill_category[]" placeholder="Category (e.g., Languages)" value="${category}" required></div>
                                      <div class="col-md-7"><input type="text" class="form-control" name="skill_names[]" placeholder="Skills (comma-separated)" value="${names}" required></div>
                                      <div class="col-md-1"><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.dynamic-entry').remove()"><i class="fas fa-times"></i></button></div>
                                  </div>`;
             container.appendChild(newEntry);
        }
        
        // --- AI Generation Functions (Unchanged) ---
        async function generateExperience(id) { /* ... same as before ... */ }
        async function generateProject(id) { /* ... same as before ... */ }
        async function generateSummaryOptions() { /* ... same as before ... */ }
        function copyToClipboard(text) { /* ... same as before ... */ }

        // --- Page Load Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const dataElement = document.getElementById('portfolio-data');
            const existingData = JSON.parse(dataElement.textContent || '{}');

            if (existingData && existingData.id) {
                // Populate existing entries
                (existingData.experiences || []).forEach(exp => addEntry('experience', exp));
                (existingData.educations || []).forEach(edu => addEntry('education', edu));
                (existingData.projects || []).forEach(proj => addEntry('project', proj));
                (existingData.certificates || []).forEach(cert => addEntry('certificate', cert));
                if (existingData.skills) {
                    for (const [category, names] of Object.entries(existingData.skills)) {
                        addSkillCategory(category, names);
                    }
                }
            } else {
                // Add one of each entry for a new portfolio
                addEntry('experience');
                addEntry('education');
                addEntry('project');
                addSkillCategory('Languages', 'Python, JavaScript, SQL');
            }
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</body>
</html>